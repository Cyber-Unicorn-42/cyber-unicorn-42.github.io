---
layout: post
read_time: true
show_date: true
title:  What is SPF, DKIM and DMARC
date:   2021-10-16 10:00:00 +1000
description: A non-technical explanation of what SPF, DKIM and DMARC are.
img: posts/2021-10-16-SPF-DKIM-DMARC/hero.png
tags: [non-technical,security,email]
author: Peter Dodemont
published: true
---
In this article I will try to explain what SPF, DKIM and DMARC are and why they are worthwhile to implement. I will not cover how to implement them (I might do this in a future article). And while I cover some of the weaknesses, it is by no means a comprehensive list.

## SPF
SPF stands for Sender Policy Framework; it is a mechanism that can be used to determine if the server that sent a particular email is allowed to send emails from the email address the email came from. There are 2 main components needed for this to work.
First, the owner of the domain needs to setup a record of what infrastructure is allowed to send email for their domain. This record includes any servers and services that can legitimately send emails from that domain, but it also includes a recommendation on what action to take when the message is received from servers and services that are not specified as legitimate.
Second, the receiving server needs to check those records and act accordingly (this can be as per the recommendation in the record, or a different action specified by the administrator of the receiving server).
There is a great benefit to being able to precisely specify what infrastructure is allowed to send emails from a specific domain, but there a number of limitations with SPF. Below are some of the most significant limitations.
Malicious actors are able to forge emails by using 2 different sender email addresses, 1 that is visible in the email client (e.g. Outlook or the web interface of your mail provider) and a 2nd one that is used by the receiving server for checking SPF records and sending failure messages to. I'm not going to cover off in details why these 2 different addresses exist, but in short it is to allow 3rd parties to send emails and processes any failures rather than them going to the email that is visible in the client (think of a newsletter coming from a marketing department, the marketing department mailbox could get overloaded with failure messages each time newsletter comes through).
The previous issue is especially of concern, if cloud services (think Office 365 or SendGrid) are used to send emails. At cloud services, the server infrastructure is usually shared between multiple (if not all) customers. In combination with previous issues this could be a significant problem as the SPF records would pass validation but use a visible email address that is different. This issue is mitigated by most cloud providers, as they require the owner of the domain to prove what domains they own (this happens through a variety of ways). The service will then block any emails sent from that customer that do not contain domains that were validated by that customer. However, malicious actors are able to setup their own email services, and these will also be setup to pass the SPF checks, but they will not validate the visible email. Most email services use another mechanism to counter this type of incoming SPAM, by consulting and contributing to large lists of servers known to send out SPAM (but that is not part of SPF or any other technology discussed in this article).
Finally, for all intents and purposes there is a limit on how many servers can be configured as allowed (there is ways around this, but that setup isn't maintainable in the long term).

## DKIM
DKIM stands for DomainKeys Identified Mail. DKIM is used to validate that the actual message itself, as opposed to the sending infrastructure the message was sent from. With DKIM each message gets digitally signed using a cryptographic key pair. The pair consists of a private and a public key (as the name suggests the private key is something only the owner of the domain will know and has access to, and the public key is freely accessible to everyone). It works as follows: the owner of the domain sets up a unique private key on each server or service they use; these services then sign each message using that private key; the owner of the domain then also publishes a corresponding unique public key in a predetermined location (that is freely accessible by everyone); finally, the server receiving the email can then use the public key to validate the digital signature.
It's important to note that the public key cannot be used to work out what the private key is, and if someone were to use the public key to sign any emails and send them, they would also not verify as legitimate. Only messages signed by the private key can be verified with the corresponding public key.
If a malicious actor were able to intercept the email message in transit, any modifications to the content would also invalidate the signature.
Unlike SPF, there is no limitation on the number of keys that can be setup. There is also no issue using this with cloud services, as each key pair is unique, and it is not shared between customers of a cloud service. Since it is randomly generated it is extremely unlikely that the same key pair will get randomly generated on another service or by another customer.
Just like SPF, there are some things to be aware of. While the vast majority of large services support DKIM, it is not universally supported at the moment.
It also doesn't provide for a mechanism to advise what the receiving server should do with messages that do not pass the validation; it is up to the administrator of the receiving email domain to determine the course of action.
If someone is able to first compose then send and retrieve a saved copy of the email as a file, they would be able to forward this email from any service that allows it and have a message that will pass validation.

## DMARC
DMARC stands for Domain-based Message Authentication, Reporting and Conformance. DMARC leverages SPF and DKIM to provide a more robust way of validating email messages and it also provides a mechanism to report who is sending email from a domain back to the owner of the domain.
Unlike SPF and DKIM, DMARC cannot be used by itself, it relies on SPF and/or DKIM to already be in place. With DMARC the owner of a domain can specify if a particular message has to pass the checks for SPF, DKIM or both. It also allows for specifying how to handle messages where the visible email and the from email used by the servers are not the same (see the [SPF](#SPF) section for more details). Like SPF, DMARC also allows the domain owner to specify what they believe should be done with messages that fail validation. Since DMARC relies on SPF and DKIM for its validation, I will not go over the exact details again here, instead I will focus on the additional functionality enabled by DMARC, namely reporting.
As mentioned, with DMARC the owner of the domain can receive reports on the usage of their domain. There are 2 types of reports that can be sent. An aggregate report and a forensic report. The reports are generated by the service receiving the email and then emailed to an email address (or multiple email addresses) that the domain owner specifies.
The aggregate report usually gets sent once a day and contains a list of servers and if the emails received passed or failed SPF, DKIM or both. Each combination is listed individually and also contains a count of how many emails matched that combination. This report is useful to get a general overview of what is happening and to check if there is a particular server, that is sending lots of messages that are failing, that needs to be investigated. This can be a legitimate service or malicious traffic. E.g. if a new newsletter service is being used and the SPF and DKIM policies have not been updated, emails from that service will be flagged as failing the SPF and/or DKIM checks.
The forensic report deals with only a single message and is sent as soon as the message that failed to pass validation is received by the server. These reports contain more details than the aggregate report (they contain the subject line among other additional details) and are used when doing investigations (usually triggered by looking at the aggregate reports).
As DMARC does not provide any new mechanisms for validation its limitations are of a different nature. The biggest drawback is that the reports are not in a format that is easily readable by a human, they are meant to be processed by a system. Fortunately, there are providers out there that offer free analysis of these reports (e.g. [https://report-uri.com]). Most of the free providers have limitations of some kind, but they are a good place to get started. If they suit your needs, they generally also offer paid plans, and with the ability to use multiple emails for each type of report you can easily transition between providers or even run multiple side by side if you decide that is a better course of action.

I hope that you now have a better understanding of what each of these technologies does. And while implementing these for your own domain won't necessarily make a big difference to your own users, they will greatly improve the security of anyone you do business with. Not to mention that once implemented anyone receiving an email from your domain will have greater confidence it is a legitimate email, which in turn will increase the likelihood of the emails getting delivered. There is also the benefit of being able to protect your domain and your brand from abuse and reputational damage by preventing a malicious actor from using it.

As always if you have any questions or comments, please reach out.